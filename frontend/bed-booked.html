<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediQuick - Bed Booked</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&family=Lora:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="header">
        <a href="index.html" class="logo-link">
        Mediquick
        </a>
    </div>

    <div class="container">
        <div class="hospital-info">
            Your Bed is booked in:<br>
            <span id="hospitalAddress">//hospital address</span><br><br>
            <span id="countdownTimer" style="font-weight: bold; color: red;"></span>
        </div>
        <div id="countdownTimer" style="margin-top: 20px; font-size: 18px; color: #b22222;"></div>

        <div class="result-box">
            <p class="result-text">Would you like us to book an ambulance for you?</p>
            <div class="button-group" id="ambulanceButtons">
                <button class="btn" onclick="bookAmbulance()">Yes</button>
                <button class="btn" onclick="noAmbulance()">No</button>
            </div>
            <div id="ambulanceResponse" class="result-text hidden"></div>
        </div>
    </div>

    <script>
    let admitted = false;
    let countdownInterval = null;
    let statusCheckInterval = null;

    window.onload = function () {
        const bookingData = JSON.parse(localStorage.getItem("bookingResult"));
        const userName = localStorage.getItem("userName");
        const userPhone = localStorage.getItem("userPhone");

        if (!bookingData) {
            document.getElementById("hospitalAddress").textContent = "No booking data found.";
            return;
        }

        const displayText = `
            ğŸ¥ <strong>Hospital:</strong> ${bookingData.hospital}<br>
            ğŸ›ï¸ <strong>Bed Number:</strong> ${bookingData.bed_number}<br>
            ğŸ‘¨â€âš•ï¸ <strong>Doctor:</strong> ${bookingData.doctor} (${bookingData.specialization})<br>
            ğŸ§‘â€ğŸ¤â€ğŸ§‘ <strong>Patient:</strong> ${userName} (${userPhone})<br>
            ğŸš¨ <strong>Emergency Type:</strong> ${bookingData.emergency_type}
        `;
        document.getElementById("hospitalAddress").innerHTML = displayText;

        // Start the timer + backend poll
        startCountdown();
        statusCheckInterval = setInterval(() => pollPatientStatus(userPhone), 5000);
    };

    function startCountdown() {
        let duration = 60; // seconds
        const countdown = document.getElementById("countdownTimer");

        countdownInterval = setInterval(() => {
            if (admitted) {
                countdown.textContent = "âœ… You are admitted.";
                clearInterval(countdownInterval);
                clearInterval(statusCheckInterval);
                return;
            }

            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            countdown.textContent = `â³ Bed will be held for ${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;

            if (--duration < 0) {
                clearInterval(countdownInterval);
                clearInterval(statusCheckInterval);
                countdown.textContent = "âŒ Bed hold expired. Please refresh or try again.";
            }
        }, 1000);
    }

    async function pollPatientStatus(phone) {
        try {
            const res = await fetch(`http://127.0.0.1:5000/check-patient-status?phone=${phone}`);
            const data = await res.json();
            if (data.status === 'booked') {
                admitted = true;
                document.getElementById("countdownTimer").textContent = "âœ… You are admitted.";
                clearInterval(countdownInterval);
                clearInterval(statusCheckInterval);
            }
        } catch (err) {
            console.error("âŒ Failed to poll patient status:", err);
        }
    }

    function bookAmbulance() {
        const responseDiv = document.getElementById('ambulanceResponse');
        responseDiv.textContent = 'ğŸš‘ An ambulance is being sent to your location. Please stay calm.';
        responseDiv.classList.remove('hidden');
        document.getElementById('ambulanceButtons').style.display = 'none';
    }

    function noAmbulance() {
        const responseDiv = document.getElementById('ambulanceResponse');
        responseDiv.textContent = 'ğŸ›£ï¸ No ambulance requested. Please reach the hospital safely.';
        responseDiv.classList.remove('hidden');
        document.getElementById('ambulanceButtons').style.display = 'none';
    }

    // External trigger for manual admission (if needed)
    window.setAdmittedStatus = function (status) {
        admitted = status;
    };
</script>

</body>
</html>
